<html>
    <head>
        <title>Catch Bulbasaur</title>
        <link rel="stylesheet" href="style2.css">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="ar-components.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
        
    </head>
    <body class="inline">
        <a-scene webxr="optionalFeatures: hit-test, dom-overlay; overlayElement:#overlay;" cursor="rayOrigin:mouse">
            <a-assets timeout="30000">
                <a-asset-item id="bulbasaur" src="assets/bulbasaur.glb"></a-asset-item>
            </a-assets>
            <a-sphere id="ball" dynamic-body radius="0.1" color="orange" position="0.1 2.36 -1.5"></a-sphere>
            <a-camera position="0 1.5 0"></a-camera>
            <a-entity environment="preset: forest; dressingAmount: 500" hide-in-ar-mode static-body></a-entity>
            <a-entity id="character" position="0 0 -2.5" scale="1.3 1.3 1.3" hide-in-ar-mode static-body>
                <a-entity position="0 0 0" rotation="0 180 0" gltf-model="#bulbasaur" scale="1 1 1"></a-entity>
            </a-entity>
            <a-sky color="#ECECEC" hide-in-ar-mode></a-sky>
            <a-entity light="type: ambient; intensity: 0.7;"></a-entity>
            <a-light type="directional" id="light" target="character" position="2 1 1.5"></a-light>
            
            <a-entity ar-hit-test="doHitTest:false" visible="false">
				<a-plane
					rotation="-90 0 0"
					width="0.2"
					height="0.2"
					src="assets/arrow.png"
					material="transparent:true;"
				></a-plane>
			</a-entity>
        </a-scene>
        <div id="overlay" class="container">
			<div id="ar-instructions">
				<section class="overlay-content">
					<p id="instructions">Place the pokemon on the marker</p>
				</section>
				<div style="display: flex; justify-content: space-between; align-self: stretch;">
					<button id="go-button">Ready to Play!</button>
					<button id="exit-button">Stop AR</button>
				</div>
			</div>
			<div id="inline-instructions">
				<section class="overlay-content">
					<p>Enter AR to Start Playing</p>
				</section>
			</div>
		</div>
        <script>
			const reticle = document.querySelector("[ar-hit-test]");
			const hoop = document.getElementById('hoop');
			const instructions = document.getElementById('instructions');
			const ball = document.getElementById('ball');
			const button = document.getElementById('go-button');
			const exit = document.getElementById('exit-button');
			const upVector = new THREE.Vector3(0, 1, 0);
			const tempVector = new THREE.Vector3();
			const tempQuaternion = new THREE.Quaternion();
			const scene = document.querySelector('a-scene');

			function hasDomOverlay(session) {
				if (!session.domOverlayState) {
					// DOM Overlay is not supported
					return false;
				}

				if (!session.domOverlayState.type) {
					// DOM Overlay is not in use
					return false;
				}

				return true;
			}

			function positionPokemon() {
				hoop.setAttribute("position", reticle.getAttribute("position"));
				hoop.setAttribute("visible", true);
			};

			exit.addEventListener('click', function () {
				scene.xrSession.end();
			});

			scene.addEventListener("enter-vr", () => {
				const domOverlay = hasDomOverlay(scene.xrSession);
				document.getElementById('text').setAttribute('text', 'value', 'Overlay: ' + domOverlay);
				document.body.classList.remove("inline");
				if (scene.is("ar-mode")) {
					document.body.classList.add("ar-preparing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:true');
					reticle.setAttribute('visible', 'true');
				} else {
					document.body.classList.add("playing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:false');
					reticle.setAttribute('visible', 'false');
				}
			});

			scene.addEventListener("exit-vr", () => {
				document.body.classList.add("inline");
				document.body.classList.remove("playing");
				document.body.classList.remove("ar-preparing");
				reticle.setAttribute('ar-hit-test', 'doHitTest:false');
				reticle.setAttribute('visible', 'false');
			});

			reticle.addEventListener('select', function (e) {
				const domOverlay = hasDomOverlay(scene.xrSession);
				if (document.body.classList.contains("playing")) {
					const pose = e.detail.pose;
					ball.body.position.copy(pose.transform.position);
					// ball.body.position.y += 0.2;
					tempVector.set(0, 0 ,-5);
					tempVector.applyQuaternion(pose.transform.orientation);
					ball.body.velocity.copy(tempVector);
					return;
				}

				if (domOverlay) {
					setTimeout(() => {
						if (document.body.classList.contains("playing")) {
							return;
						} else {
							positionPokemon();
						}
					}, 50);
				} else {
					if (document.body.classList.contains("playing")) {
						return;
					} else {
						if (this.components["ar-hit-test"].hasFoundAPose) {
							positionPokemon();
							readyToStartPlay(e);
						}
					}
				}
			});

			function readyToStartPlay(e) {
				e.preventDefault();
				if (hoop.getAttribute("visible") === false) {
					positionPokemon();
				}
				if (document.body.classList.contains("ar-preparing")) {
					document.body.classList.remove("ar-preparing");
					document.body.classList.add("playing");
					reticle.setAttribute('ar-hit-test', 'doHitTest:false');
					reticle.setAttribute('visible', 'false');
					return;
				}
			}

			button.addEventListener('mousedown', readyToStartPlay);
			button.addEventListener('touchstart', readyToStartPlay);
		</script>
    </body>
</html>